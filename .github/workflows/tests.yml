name: Full CI/CD Pipeline - Separate Frontend & Backend

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ===============================
  # Backend tests
  # ===============================
  backend-tests:
    name: Backend tests (Maven + JaCoCo)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Run backend tests and generate JaCoCo report
        working-directory: ./backend
        run: mvn -B test org.jacoco:jacoco-maven-plugin:0.8.8:report

      - name: Upload backend coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/target/jacoco.exec

  # ===============================
  # Frontend tests
  # ===============================
  frontend-tests:
    name: Frontend tests (Jest coverage)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install frontend dependencies
        working-directory: frontend/travel
        run: npm ci

      - name: Run frontend tests with coverage
        working-directory: frontend/travel
        run: npm test -- --coverage --watchAll=false

      - name: Upload frontend coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: frontend/travel/coverage/**

  # ===============================
  # Backend build
  # ===============================
  backend-build:
    name: Build backend
    runs-on: ubuntu-latest
    needs: backend-tests
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Build backend
        working-directory: ./backend
        run: mvn -B package

      - name: Upload backend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: backend/target/*.jar

  # ===============================
  # Frontend build
  # ===============================
  frontend-build:
    name: Build frontend
    runs-on: ubuntu-latest
    needs: frontend-tests
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install frontend dependencies
        working-directory: frontend/travel
        run: npm ci

      - name: Build frontend
        working-directory: frontend/travel
        run: npm run build

      - name: Upload frontend build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/travel/dist/**

  # ===============================
  # Docker build & push backend
  # ===============================
  docker-backend:
    name: Build & Push Backend Docker Image
    runs-on: ubuntu-latest
    needs: backend-build
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build backend Docker image
        run: |
          docker build -t nikogrizek/backend:latest ./backend

      - name: Push backend Docker image
        run: docker push nikogrizek/backend:latest

  # ==============================
  # Docker build & push frontend
  # ==============================
  docker-frontend:
    name: Build & Push Frontend Docker Image
    runs-on: ubuntu-latest
    needs: frontend-build
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build frontend Docker image
        run: |
          docker build -t nikogrizek/frontend:latest ./frontend/travel

      - name: Push frontend Docker image
        run: docker push nikogrizek/frontend:latest

  # ===============================
  # Deploy backend to Render
  # ===============================
  deploy-backend:
    name: Deploy Backend to Render
    runs-on: ubuntu-latest
    needs: docker-backend
    steps:
      - uses: actions/checkout@v4

      - name: Deploy Backend via Render API
        run: |
          curl -X POST https://api.render.com/deploy/srv-backend-id \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"

  # ===============================
  # Deploy frontend to Render
  # ===============================
  deploy-frontend:
    name: Deploy Frontend to Render
    runs-on: ubuntu-latest
    needs: docker-frontend
    steps:
      - uses: actions/checkout@v4

      - name: Deploy Frontend via Render API
        run: |
          curl -X POST https://api.render.com/deploy/srv-frontend-id \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"

  # ===============================
  # Deploy static description site to GitHub Pages
  # ===============================
  deploy-pages:
      name: Deploy GitHub Pages
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        - name: Deploy to GitHub Pages
          uses: peaceiris/actions-gh-pages@v5
          with:
            github_token: ${{ secrets.GITHUB_TOKEN }}
            publish_dir: ./docs

  deploy-dev:
    name: Deploy to Development
    runs-on: ubuntu-latest
    environment: Development
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/myapp:dev ./backend
          docker push ${{ secrets.DOCKER_USERNAME }}/myapp:dev
    
    deploy-prod:
      name: Deploy to Production
      runs-on: ubuntu-latest
      environment: Production
      steps:
        - uses: actions/checkout@v4
        - name: Log in to Docker Hub
          uses: docker/login-action@v2
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}
        - name: Build and push Docker image
          run: |
            docker build -t ${{ secrets.DOCKER_USERNAME }}/myapp:prod ./backend
            docker push ${{ secrets.DOCKER_USERNAME }}/myapp:prod
  